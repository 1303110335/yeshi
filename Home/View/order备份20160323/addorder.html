<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>确认订单</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta content="telephone=yes" name="format-detection" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="stylesheet" href="__CSS__/css1.css">
<link rel="stylesheet" href="__CSS__/swiper.min.css">
<link rel="stylesheet" href="__CSS__/iconfont1/iconfont1.css">
<link rel="stylesheet" href="__CSS__/iconfont2/iconfont2.css">
<link rel="stylesheet" href="__CSS__/iconfont/iconfont.css">
<!--<script type="text/javascript" src="http://api.map.baidu.com/api?v=1.2"></script>
<script type="text/javascript" src="http://api.map.baidu.com/library/GeoUtils/1.2/src/GeoUtils_min.js"></script>
-->




<style>
.zhifu{
  display: block;
    background: #d12227;
    line-height: 45px;
    text-align: center;
    border-radius: 5px;
    margin-top: 20px;
    font-size: 16px;
    color: #fff;
  width:100%;
  border:none;
  }
.sccg{
	width:120px;
	height:80px;
	background:rgba(0,0,0,0.8);
	position:fixed;
	top:50%;
	left:50%;
	margin-top:-40px;
	margin-left:-60px;
	border-radius:10px;
	-moz-border-radius:10px;
	-webkit-border-radius:10px;
	-o-border-radius:10px;
	display:none;
	}
.sccgtb{
	width:25px;
	height:25px;
	margin-top:15px;
	color:#F29200;
	}
.sccg p{
	text-align:center;
	color:#ccc;
	margin-top:5px;
	}
</style>
</head>
<body id="scroll_top">
<div id="jiazai" style=" background:rgba(255,255,255,0.3);width:100%;height:100%; position:fixed; z-index:99999999999999999999999;display:none"></div>
<!-- top --> 
<input type="hidden" value="{$goodsdetail.yunfei2}" id="yunfei2">
<input type="hidden" value="{$goodsdetail.newprice2}" id="newprice_2">
<!-- top --> 
<!-- main_div -->
<input type="hidden" value="{$dealerlist}" id="dealerlist">
<input type="hidden" id="xg" value="{$goodsdetail.restriction_num}">

<div style="display:ne" id="container"></div>

<form action="{:U('Order/orderadd')}" method="post" id="theForm">
<div class="main_div" style=" background:#f1f1f2; padding-bottom:100px">
  <div class="qrzf">
    <div class="qrzf_dz">
      <div class="qrzf_dz_left">
        <h1>送至<span>{$addressdetail.consignee}&nbsp;&nbsp;{$addressdetail.telephone}</span></h1>
        <p>{$addressdetail.province} {$addressdetail.city} {$addressdetail.country} {$addressdetail.xiangqing}</p>
      </div>
      <input name="consignee" type="hidden" value="{$addressdetail.consignee}">
      <input name="telephone" type="hidden" value="{$addressdetail.telephone}">
      <input name="country" type="hidden" value="中国">
      <input name="province" type="hidden" value="{$addressdetail.province}">
      <input name="city" type="hidden" value="{$addressdetail.city}">
      <input name="district" type="hidden" value="{$addressdetail.country}">
      <input name="address" type="hidden" value="{$addressdetail.xiangqing}">
    </div>
    <div class="clear"></div>
  </div>
  <div class="qrzf">
    <div class="qrzf_cp">
      <div class="qrzf_cp_left"> <img src="{$goodsdetail.pic}" width="100%"> </div>
      <div class="qrzf_cp_right">
        <h1>{$goodsdetail.good_name}</h1>
        <p style="margin-top:5px;">规格：{$guige}</p>
        <p>数量：<font>1</font> <span class="shuliang">￥ {$goodsdetail.guige_price}</span><span class="damwei">/件</span></p>
      </div>
    </div><input name="price" id="price" type="hidden" value="{$goodsdetail.guige_price}">
    <input name="priceall" id="priceall" type="hidden" value="{$goodsdetail.newprice}">
    <input name="goodsid" id="goodsid" type="hidden" value="{$goodsdetail.id}">
    <input name="guigeid" id="guigeid" type="hidden" value="{$guigeid}">
    <input name="pic" id="pic" type="hidden" value="{$goodsdetail.pic}">
    <input name="guige" id="guige" type="hidden" value="{$guige}">
    <input name="d_price" id="d_price" type="hidden" value="{$goodsdetail.guige_price}">
    <input name="good_name" id="good_name" type="hidden" value="{$goodsdetail.good_name}">
    <input name="dealerNum" id="dealerNum" type="hidden" value="no">
    <div class="clear"></div>
  </div>
  <div class="qrzf_sl">
    <div class="qrzf_sl_xz">
      <ul>
        <li>
          <div class="qrzf_sl_xzs" onClick="jian()"> - </div>
        </li>
        <li>
          <div class="qrzf_sl_xzs" style=" border:none; background:#fff;">
            <p>
              <input class="xdsl" name="nums" id="nums" onChange="cha()" type="text" value="1">
              件</p>
            <div class="clear"></div>
          </div>
        </li>
        <li>
          <div class="qrzf_sl_xzs" onClick="jia()"> + </div>
        </li>
      </ul>
      <div class="clear"></div>
    </div>
    
    
<!--    <div class="qrzf_sl_jg">
      <p>使用优惠券：<span>
      <select name="coupon_fee" id="coupon_fee" onChange="coupon_fee1()">
      <option value="0">无</option>
      <option value="10">立减10</option>
      <option value="20">立减20</option>
      </select></span></p>
    </div>-->

    <div class="qrzf_sl_jg mgt10">
    
        <div class="user_yhq">
            <div class="user_yhq2">
                <!-- user_yhq2_js -->
                <select id="demo2">
                  <option value="0">无</option>
                <volist name="coupon" id="vo">
                  <option value="{$vo.id}">{$vo.title}:{$vo.price}元</option>
                </volist>
                </select>
                <!-- user_yhq2_js -->
            </div>
            <div class="user_yhq1">使用优惠券：</div>
            <div class="clear"></div>
        </div>
        <input type="hidden" name="shipping_fee" value="{$goodsdetail.yunfei}">
        <input type="hidden" id="newprice2" value="{$goodsdetail.guige_price}">
        <input type="hidden" id="newprice" value="{$goodsdetail.newprice}">
    <p>快递：¥<span id="yunfei" style="font-size:10px;color:#8A8A8A;">{$goodsdetail.yunfei}</span> 需付款：<span>¥<font id="showmoney">{$goodsdetail.newprice}</font></span></p>
    </div>

    

    
    <div class="clear"></div>
  </div>
  <div class="qrzf_zf">
    <h1>请选择支付方式</h1>
    <div class="clear"></div>
    <div class="qrzf_fs">
      <div class="qrzf_fsnav">
        <ul>
          <li style=" border-bottom: #e4e4e4 1px solid;">
            <h1><span class="iconfont" style=" color:#00cf0d;"><img style="vertical-align:middle;text-align:position;" src="__IMAGES__/iconfont-weizhifu.svg" width="23"></span>微信支付</h1>
          </li>
          <li>
            <input type="text" placeholder="填写订单备注" name="content" style=" line-height:50px; font-size:14px; color: #b2b0b0;width:100%; border:none;">
          </li>
        </ul>
      </div>
    </div>
  </div>
  <div class="qrzf_zf">
    <h1><span style="color:#d12227">是否上门提货</span></h1>
    <div class="clear"></div>
    <div class="qrzf_fs">
      <div class="qrzf_fsnav">
        <ul>
          <li style=" border-bottom: #e4e4e4 1px solid;">
            <div class="dzform">
              <label><input class="fdan" type="radio" name="RadioGroup1" value="1" id="RadioGroup1_0" <if condition="$goodsdetail.is_delivery eq 1"> checked </if> >是</label>
              <if condition="$goodsdetail.is_delivery eq 0"><label><input class="fdan1" type="radio" name="RadioGroup1" value="0" id="RadioGroup1_1" checked>否</label></if> 
              <br>
            </div>
            <div class="clear"></div>
          </li>
          
          <if condition="$goodsdetail.is_delivery eq 0">
          <div class="one">
            <div class="one1">选择自提门店</div>
          </div>
          <else/>
          <div class="one" style="display:block">
            <div class="one1">选择自提门店</div>
          </div>
          </if>
          <!--dianpu-->
          <div class="two two1" style="height:auto">
    <foreach name="store" item="vo">


        <div class="twobox overflowH1">
            <div class="two_img">
                <img src="{$vo.pic}" width="100%" style=" width:100%;">
            </div>
            <div class="two_textbox">
                  <p class="two_text"><span>店铺名：</span>{$vo.storename}<br>
                  <span>地址：</span>{$vo.address}<br>
                  <span>营业时间：</span>{$vo.opentime}<br>
                  <span>联系电话：</span>{$vo.telephone}</p>
            </div>
            <input type="radio" name="storeid" value="{$vo.id}" style="visibility:hidden;">
            </div>
    </foreach>
          </div>
          <!--dianpu-->
          
          <li> 
          <a style=" background:#d12227" href="javascript:;" class='zhifu' >立即支付</a>
          </li>
        </ul>
      </div>
    </div>
  </div>
  
</div>
</form>
<div class="sccg sccg01">
    <div class="sccgtb iconfont"><img src="__IMAGES__/loaddding.gif" style="margin-top:5px" /></div>
    <p>提交中...</p>
  </div>
  <div class="sccg sccg02">
    <div class="sccgtb iconfont"><img src="__IMAGES__/loaddding.gif" style="margin-top:5px" /></div>
    <p>提交中...</p>
  </div>
<!-- main_div -->
<div class="scorll_top"><a href="#scroll_top"><img src="__IMAGES__/scorll_top.png" width="30"></a></div>
<!-- footer -->
<include file="Public:foot" />
<!-- footer --> 
<!--统计流量-->
<div style="display:none;">
<script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1257387489'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s11.cnzz.com/z_stat.php%3Fid%3D1257387489%26show%3Dpic' type='text/javascript'%3E%3C/script%3E"));</script>
</div>
<!--统计流量-->
</body>
<script src="__JS__/jquery.min.js"></script>
<script src="__JS__/layer/layer.js"></script>
<script>
  layer.load(1, {
    shade: [0.1,'#fff'] //0.1透明度的白色背景
});
</script>
<script type="text/javascript">
document.write("<scr"+"ipt src=\"http://api.map.baidu.com/api?v=1.2\"></sc"+"ript>")
document.write("<scr"+"ipt src=\"http://api.map.baidu.com/library/GeoUtils/1.2/src/GeoUtils_min.js\"></sc"+"ript>")
</script>


<script src="__JS__/js.js"></script>
<!-- user_yhq2_js -->
<script src="__JS__/jquery-1.8.3.min.js"></script>
<script src="__JS__/dropdownlist.js"></script>

<script>

	var dealerlistcot = {$dealerlistcot},longitude = Array(),latitude = Array(),dealerNum = 0;
	var map = new BMap.Map("container");
	
	<?php for($i=0; $i<$dealerlistcot; $i++){ ?>
    longitude[{$i}] = "{$dealerlist.$i.longitude}".split(',');//经度
    latitude[{$i}] = "{$dealerlist.$i.latitude}".split(',');//纬度
    var pts = [];
    for(var j=0; j<longitude[{$i}].length; j++){
      pts.push(new BMap.Point(longitude[{$i}][j],latitude[{$i}][j]));
    }
    var ply = new BMap.Polygon(pts);
    var pt =new BMap.Point("{$xz}", "{$yz}"); 
    var result = BMapLib.GeoUtils.isPointInPolygon(pt, ply);
    if(result == true){
      dealerNum = 1;
        $('#dealerNum').val({$i});
    }
	if(dealerNum==1){
		/*$('#showmoney').text($('#newprice_2').val());
		$('#yunfei').text($('#yunfei2').val());
		$("#priceall").val($('#newprice_2').val());
		$('.qrzf_sl_jg font').text($('#newprice_2').val());
		$('input[name=shipping_fee]').val($('#yunfei2').val());*/
	}
	<?php } ?>


	var jiazai_hei=document.body.clientHeight;
	$('#jiazai').css('height',jiazai_hei);
	$(document).ready(function($){
		
		$(".overflowH1").click(function(){
			$(".overflowH1").css("background","#ffffff");
			$(".overflowH1 .two_textbox").css("color","#888888");   
			$(this).css("background","#e8e8e8");
			$(this).find('.two_textbox').css("color","#ffffff") 
			$(this).children('input[type=radio]').prop('checked',true);
		})
	});     
	
	var restriction_num = $('#xg').val();
	
	if(dealerNum==1)
	{
		var shipping_fee = parseFloat($('#yunfei2').val());
	}
	else
	{
		var shipping_fee = parseFloat($('input[name=shipping_fee]').val());
	}

	var goodsId = $('#goodsid').val(), freightId = {$freightId}; 
	     
$.ajax({
  url:"{:U('Home/Order/ajaxyunfei')}",
  type:"post",
  async:false,
  data:{dealerNum:$('#dealerNum').val(),guigeid:$("#guigeid").val(),goodsid:goodsId,freightId:freightId},
  success:function(ret){
    layer.closeAll();
    var mon = parseFloat(ret)+parseFloat($("#price").val());
    $("#priceall").val(mon);
    $('.qrzf_sl_jg font').text(mon);
    $('#yunfei').text(ret);//运费
    $('input[name=shipping_fee]').val(ret);
  }
});

	function jia(){
		var price= $("#price").val();
		var nums= $("#nums").val();
		var is_delivery = $('input[name="RadioGroup1"]:checked').val();
		nums++;
		
		var yunfei = ajaxFreight(goodsId,nums,dealerNum,freightId);
		if(is_delivery == 1)
		{
			yunfei = 0;
		}
		var prices = nums*parseFloat(price)+parseFloat(yunfei);
		$("#nums").val(nums);
		$("#priceall").val(prices);
		$('.qrzf_cp_right font').text(nums);
		$('.qrzf_sl_jg font').text(prices);
		$('#yunfei').text(yunfei);//运费
		$('input[name=shipping_fee]').val(yunfei);
	
	}
	
	function jian(){
		var price= $("#price").val();
		var nums= $("#nums").val();
		var is_delivery = $('input[name="RadioGroup1"]:checked').val();
		nums--;
		if(nums<1){nums++;}
        var yunfei = ajaxFreight(goodsId,nums,dealerNum,freightId);
		if(is_delivery == 1)
		{
			yunfei = 0;
		}
		var prices = nums*parseFloat(price)+parseFloat(yunfei);
		$("#nums").val(nums);
		$("#priceall").val(prices);
		$('.qrzf_cp_right font').text(nums);
		$('.qrzf_sl_jg font').text(prices);
		$('#yunfei').text(yunfei);//运费
		$('input[name=shipping_fee]').val(yunfei);
	}
	
	function cha(){
		var price= $("#price").val();
		var nums= $("#nums").val();
		var is_delivery = $('input[name="RadioGroup1"]:checked').val();
		if(nums<1){nums=1;}
        var yunfei = ajaxFreight(goodsId,nums,dealerNum,freightId);
		if(is_delivery == 1)
		{
			yunfei = 0;
		}
		var prices = nums*parseFloat(price)+parseFloat(yunfei);
		$("#nums").val(nums);
		$("#priceall").val(prices);
		$('.qrzf_cp_right font').text(nums);
		$('.qrzf_sl_jg font').text(prices);
		$('#yunfei').text(yunfei);//运费
		$('input[name=shipping_fee]').val(yunfei);
	}
	function coupon_fee1(){
		var price= $("#price").val();
		var nums= $("#nums").val();
		var coupon_fee= $("#coupon_fee").val();
		var prices=price*nums-coupon_fee;
		$("#nums").val(nums);
		$("#priceall").val(prices);
		$('.qrzf_cp_right font').text(nums);
		$('.qrzf_sl_jg font').text(prices);
	}




	$(function(){
	   $('input[name=RadioGroup1]').click(function(){
		var nums= $("#nums").val();
		var price= $("#price").val();
		if($(this).val()==1){
		  var yunfei = 0;
		  var prices = nums*parseFloat(price)+parseFloat(yunfei);
			$("#nums").val(nums);
			$("#priceall").val(prices);
			$('.qrzf_cp_right font').text(nums);
			$('.qrzf_sl_jg font').text(prices);
			$('#yunfei').text(yunfei);//运费
			$('input[name=shipping_fee]').val(yunfei);
		}else{
			var yunfei = ajaxFreight(goodsId,nums,dealerNum,freightId);
			var prices = nums*parseFloat(price)+parseFloat(yunfei);
			$("#nums").val(nums);
			$("#priceall").val(prices);
			$('.qrzf_cp_right font').text(nums);
			$('.qrzf_sl_jg font').text(prices);
			$('#yunfei').text(yunfei);//运费
			$('input[name=shipping_fee]').val(yunfei);
		}
	   });
		
		// 通过原生select控件创建自定义下拉框
		var ddl_picture = DropDownList.create({
			select:$('#demo2'),
			attrs:{
				column :5,
				width :200,
		  
			}
		});
		ddl_picture.change(function(){
		//alert(ddl_picture.val());
		});
	}); 
	
	function ajaxFreight(id,num,dealerNum,freightId){
	  var guigeid = $("#guigeid").val();
	  var temp = 0;
	  $.ajax({
		//url:"{:U('Home/Goods/ajaxFreight')}",
    url:"{:U('Home/Order/ajaxyunfei')}",
		data:{goodsid:id,number:num,dealerNum:$('#dealerNum').val(),freightId:freightId,guigeid:guigeid},
		type:"post",
		async:false,
		dataType:"json",
		success:function(ret){
		  temp = ret
		}
	  });
	  return temp;
	}



  $('.zhifu').click(function(){
    var temp = 1;
    if($('input[name=RadioGroup1]:checked').val()==1){
      if(isNaN($('input[name=storeid]:checked').val())){
        temp = 0;
      }else{
        temp = 1;
      }
    }
    if(temp==1){
      $.ajax({
          url: $('#theForm').attr('action'),
          data: $('#theForm').serialize(),
          type: "post",
          dataType: "json",
		  beforeSend: function() { //开始上传 
					$('#jiazai').show(); //显示加载条
					$('.sccg01').show();
				}, 
      }).done(function (g) {

          if(1==g){
            location.href="{:U('Order/jsapi/type/1')}";
          }else if(g==0){
            alert("生成订单失败");
          }else if(g==2)
		  {
			  alert("收货地址不能为空");
			  window.location.reload();
		  }else if(g==10){
            alert("已售罄");
            $('#jiazai').hide(); //显示加载条
          $('.sccg01').hide();
          }
      });
    }else{
      alert("请选择提货的门店");
    }

  });

   
</script>
<!-- user_yhq2_js -->

</html>